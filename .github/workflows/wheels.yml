name: Wheels

on:
  push:
    branches:
      - scikit-build
      - main
  pull_request:
    branches:
      - main

jobs:
    build_wheels:
        name: Wheels on ${{ matrix.os }}
        runs-on: ${{ matrix.os }}
        strategy:
          fail-fast: false
          matrix:
            os: [ubuntu-latest, macos-latest, windows-latest]
        steps:

        - uses: actions/checkout@v4
          with:
            submodules: true
        - name: Install PLPlot on Ubuntu
          if: matrix.os == 'ubuntu-latest'
          run: |
            sudo apt-get update
            sudo apt-get install -y libplplot-dev libplplotcxx15
    
        - name: Install PLPlot on macOS
          if: matrix.os == 'macos-latest'
          run: |
            brew update
            brew install plplot
    
        - name: Install PLPlot on Windows
          if: matrix.os == 'windows-latest'
          run: |
            vcpkg install plplot
          
        - name: Cache vcpkg (Windows only)
          if: matrix.os == 'windows-latest'
          uses: actions/cache@v3
          with:
            path: vcpkg
            key: vcpkg-${{ runner.os }}-${{ hashFiles('vcpkg.json') }}
            restore-keys: |
              vcpkg-${{ runner.os }}

        - uses: pypa/cibuildwheel@v2.23.3
          with:
            config-file: "pyproject.toml"
    
        - name: Verify clean directory
          run: git diff --exit-code
          shell: bash
    
        - uses: actions/upload-artifact@v4
          with:
            name: cibw-wheels-${{ matrix.os }}
            path: wheelhouse/*.whl
